import 'dart:convert';

import 'package:airqualityapp/base/logger_utils.dart';
import 'package:airqualityapp/dependencyinjection/injection.dart';
import 'package:airqualityapp/displaycharts/api/pollution_analyzer_repository.dart';
import 'package:airqualityapp/forecast/model/forecast_list_model.dart';
import 'package:airqualityapp/forecast/viewmodel/forecast_screen_events.dart';
import 'package:geolocator/geolocator.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';

import '../../base/permission_utils.dart';
import '../../displaycharts/graph_point.dart';
import '../model/forecast_main_model.dart';

class ForecastStateNotifier extends StateNotifier<ForecastScreenEvents>{

  final _TAG = "ForecastStateNotifier";
  final _logger = locator<LoggerUtils>();
  String stateName = "";

  ForecastStateNotifier() : super(const ForecastScreenEvents.loading());

  void init() async{
    PermissionUtils permissionUtils = PermissionUtils();
    Position? userPosition = await permissionUtils.determineUserPosition();
    if(userPosition != null){
      bool isLocationPermissionAvailable = userPosition.latitude != 0.0 && userPosition.longitude != 0.0;
      if(isLocationPermissionAvailable){
        hitServerToGetWeatherForecast();
      }
      else{
        state = const ForecastScreenEvents.error();
      }
    }
    else{
      state = const ForecastScreenEvents.error();
    }

  }

  Future<void> hitServerToGetWeatherForecast() async{
    state = const ForecastScreenEvents.loading();
    PollutionAnalyzerRepository pollutionAnalyzerRepository = PollutionAnalyzerRepository();
    PermissionUtils permissionUtils = PermissionUtils();
    Position? userPosition = await permissionUtils.determineUserPosition();
    Future.delayed(Duration(seconds: 1),(){
      var jsonString = '{"cod":"200","message":0,"cnt":40,"list":[{"dt":1674626400,"main":{"temp":21.07,"feels_like":20.43,"temp_min":21.07,"temp_max":23.63,"pressure":1014,"sea_level":1014,"grnd_level":1010,"humidity":46,"temp_kf":-2.56},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"clouds":{"all":21},"wind":{"speed":3.78,"deg":357,"gust":4.21},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-25 06:00:00"},{"dt":1674637200,"main":{"temp":24.11,"feels_like":23.67,"temp_min":24.11,"temp_max":26.27,"pressure":1012,"sea_level":1012,"grnd_level":1006,"humidity":42,"temp_kf":-2.16},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":31},"wind":{"speed":4.33,"deg":321,"gust":3.9},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-25 09:00:00"},{"dt":1674648000,"main":{"temp":25.44,"feels_like":25.08,"temp_min":25.44,"temp_max":25.44,"pressure":1010,"sea_level":1010,"grnd_level":1005,"humidity":40,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":40},"wind":{"speed":6.2,"deg":323,"gust":6.61},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-25 12:00:00"},{"dt":1674658800,"main":{"temp":22.4,"feels_like":21.87,"temp_min":22.4,"temp_max":22.4,"pressure":1013,"sea_level":1013,"grnd_level":1008,"humidity":45,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":71},"wind":{"speed":4.44,"deg":344,"gust":6.16},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-25 15:00:00"},{"dt":1674669600,"main":{"temp":21.53,"feels_like":20.81,"temp_min":21.53,"temp_max":21.53,"pressure":1013,"sea_level":1013,"grnd_level":1008,"humidity":41,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],"clouds":{"all":44},"wind":{"speed":2.71,"deg":7,"gust":3.89},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-25 18:00:00"},{"dt":1674680400,"main":{"temp":20.54,"feels_like":19.69,"temp_min":20.54,"temp_max":20.54,"pressure":1012,"sea_level":1012,"grnd_level":1007,"humidity":40,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":9},"wind":{"speed":3.26,"deg":2,"gust":4.58},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-25 21:00:00"},{"dt":1674691200,"main":{"temp":20.17,"feels_like":19.26,"temp_min":20.17,"temp_max":20.17,"pressure":1011,"sea_level":1011,"grnd_level":1006,"humidity":39,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],"clouds":{"all":35},"wind":{"speed":3.35,"deg":5,"gust":4.58},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-26 00:00:00"},{"dt":1674702000,"main":{"temp":20.62,"feels_like":19.65,"temp_min":20.62,"temp_max":20.62,"pressure":1014,"sea_level":1014,"grnd_level":1009,"humidity":35,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":38},"wind":{"speed":3.58,"deg":360,"gust":4.55},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-26 03:00:00"},{"dt":1674712800,"main":{"temp":24.5,"feels_like":23.79,"temp_min":24.5,"temp_max":24.5,"pressure":1014,"sea_level":1014,"grnd_level":1009,"humidity":30,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":46},"wind":{"speed":3.19,"deg":6,"gust":3.81},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-26 06:00:00"},{"dt":1674723600,"main":{"temp":27.53,"feels_like":27,"temp_min":27.53,"temp_max":27.53,"pressure":1010,"sea_level":1010,"grnd_level":1005,"humidity":35,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":33},"wind":{"speed":4.86,"deg":317,"gust":4.47},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-26 09:00:00"},{"dt":1674734400,"main":{"temp":26.36,"feels_like":26.36,"temp_min":26.36,"temp_max":26.36,"pressure":1010,"sea_level":1010,"grnd_level":1005,"humidity":41,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":33},"wind":{"speed":5.2,"deg":315,"gust":6.28},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-26 12:00:00"},{"dt":1674745200,"main":{"temp":23.62,"feels_like":23.26,"temp_min":23.62,"temp_max":23.62,"pressure":1013,"sea_level":1013,"grnd_level":1008,"humidity":47,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":3.74,"deg":340,"gust":5.25},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-26 15:00:00"},{"dt":1674756000,"main":{"temp":22.73,"feels_like":22.26,"temp_min":22.73,"temp_max":22.73,"pressure":1012,"sea_level":1012,"grnd_level":1008,"humidity":46,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":2.22,"deg":7,"gust":3.12},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-26 18:00:00"},{"dt":1674766800,"main":{"temp":21.89,"feels_like":21.34,"temp_min":21.89,"temp_max":21.89,"pressure":1011,"sea_level":1011,"grnd_level":1006,"humidity":46,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":6},"wind":{"speed":2.46,"deg":7,"gust":3.23},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-26 21:00:00"},{"dt":1674777600,"main":{"temp":21.34,"feels_like":20.7,"temp_min":21.34,"temp_max":21.34,"pressure":1010,"sea_level":1010,"grnd_level":1006,"humidity":45,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":8},"wind":{"speed":2.2,"deg":19,"gust":2.58},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-27 00:00:00"},{"dt":1674788400,"main":{"temp":22.55,"feels_like":21.96,"temp_min":22.55,"temp_max":22.55,"pressure":1013,"sea_level":1013,"grnd_level":1008,"humidity":42,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":10},"wind":{"speed":1.73,"deg":32,"gust":2.02},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-27 03:00:00"},{"dt":1674799200,"main":{"temp":28.26,"feels_like":27.56,"temp_min":28.26,"temp_max":28.26,"pressure":1012,"sea_level":1012,"grnd_level":1008,"humidity":35,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":7},"wind":{"speed":0.78,"deg":90,"gust":2.64},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-27 06:00:00"},{"dt":1674810000,"main":{"temp":29.07,"feels_like":28.59,"temp_min":29.07,"temp_max":29.07,"pressure":1008,"sea_level":1008,"grnd_level":1004,"humidity":39,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":1},"wind":{"speed":4.41,"deg":279,"gust":3.94},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-27 09:00:00"},{"dt":1674820800,"main":{"temp":26.82,"feels_like":27.19,"temp_min":26.82,"temp_max":26.82,"pressure":1008,"sea_level":1008,"grnd_level":1004,"humidity":49,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":3.82,"deg":297,"gust":5.2},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-27 12:00:00"},{"dt":1674831600,"main":{"temp":24.93,"feels_like":24.94,"temp_min":24.93,"temp_max":24.93,"pressure":1011,"sea_level":1011,"grnd_level":1006,"humidity":56,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":0.97,"deg":351,"gust":1.76},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-27 15:00:00"},{"dt":1674842400,"main":{"temp":24.64,"feels_like":24.62,"temp_min":24.64,"temp_max":24.64,"pressure":1011,"sea_level":1011,"grnd_level":1006,"humidity":56,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02n"}],"clouds":{"all":12},"wind":{"speed":0.78,"deg":125,"gust":1.19},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-27 18:00:00"},{"dt":1674853200,"main":{"temp":24.43,"feels_like":24.42,"temp_min":24.43,"temp_max":24.43,"pressure":1009,"sea_level":1009,"grnd_level":1005,"humidity":57,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"clouds":{"all":87},"wind":{"speed":1.19,"deg":214,"gust":1.87},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-27 21:00:00"},{"dt":1674864000,"main":{"temp":23,"feels_like":23.16,"temp_min":23,"temp_max":23,"pressure":1009,"sea_level":1009,"grnd_level":1004,"humidity":69,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],"clouds":{"all":43},"wind":{"speed":1,"deg":215,"gust":1.74},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-28 00:00:00"},{"dt":1674874800,"main":{"temp":23.56,"feels_like":23.77,"temp_min":23.56,"temp_max":23.56,"pressure":1011,"sea_level":1011,"grnd_level":1006,"humidity":69,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":1.43,"deg":150,"gust":1.82},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-28 03:00:00"},{"dt":1674885600,"main":{"temp":27.9,"feels_like":28.34,"temp_min":27.9,"temp_max":27.9,"pressure":1011,"sea_level":1011,"grnd_level":1006,"humidity":50,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":2.76,"deg":204,"gust":3.01},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-28 06:00:00"},{"dt":1674896400,"main":{"temp":28.01,"feels_like":28.84,"temp_min":28.01,"temp_max":28.01,"pressure":1008,"sea_level":1008,"grnd_level":1003,"humidity":54,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":5.11,"deg":252,"gust":4.94},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-28 09:00:00"},{"dt":1674907200,"main":{"temp":26.17,"feels_like":26.17,"temp_min":26.17,"temp_max":26.17,"pressure":1008,"sea_level":1008,"grnd_level":1003,"humidity":61,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":4.63,"deg":278,"gust":5.74},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-28 12:00:00"},{"dt":1674918000,"main":{"temp":23.77,"feels_like":24.13,"temp_min":23.77,"temp_max":23.77,"pressure":1010,"sea_level":1010,"grnd_level":1005,"humidity":74,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":1.2,"deg":279,"gust":2},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-28 15:00:00"},{"dt":1674928800,"main":{"temp":23.06,"feels_like":23.43,"temp_min":23.06,"temp_max":23.06,"pressure":1010,"sea_level":1010,"grnd_level":1005,"humidity":77,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":1.48,"deg":261,"gust":1.95},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-28 18:00:00"},{"dt":1674939600,"main":{"temp":22.29,"feels_like":22.66,"temp_min":22.29,"temp_max":22.29,"pressure":1009,"sea_level":1009,"grnd_level":1004,"humidity":80,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":0.81,"deg":185,"gust":1.29},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-28 21:00:00"},{"dt":1674950400,"main":{"temp":21.8,"feels_like":22.15,"temp_min":21.8,"temp_max":21.8,"pressure":1009,"sea_level":1009,"grnd_level":1004,"humidity":81,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":0.77,"deg":295,"gust":1.46},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-29 00:00:00"},{"dt":1674961200,"main":{"temp":22.58,"feels_like":22.9,"temp_min":22.58,"temp_max":22.58,"pressure":1011,"sea_level":1011,"grnd_level":1007,"humidity":77,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":1},"wind":{"speed":1.37,"deg":144,"gust":1.46},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-29 03:00:00"},{"dt":1674972000,"main":{"temp":26.23,"feels_like":26.23,"temp_min":26.23,"temp_max":26.23,"pressure":1012,"sea_level":1012,"grnd_level":1007,"humidity":58,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":2.67,"deg":221,"gust":2.34},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-29 06:00:00"},{"dt":1674982800,"main":{"temp":26.83,"feels_like":27.55,"temp_min":26.83,"temp_max":26.83,"pressure":1009,"sea_level":1009,"grnd_level":1004,"humidity":55,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":4.33,"deg":255,"gust":3.53},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-29 09:00:00"},{"dt":1674993600,"main":{"temp":25.62,"feels_like":25.75,"temp_min":25.62,"temp_max":25.62,"pressure":1009,"sea_level":1009,"grnd_level":1004,"humidity":58,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":4.41,"deg":293,"gust":4.44},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-29 12:00:00"},{"dt":1675004400,"main":{"temp":23.26,"feels_like":23.26,"temp_min":23.26,"temp_max":23.26,"pressure":1011,"sea_level":1011,"grnd_level":1006,"humidity":62,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":2.85,"deg":336,"gust":4},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-29 15:00:00"},{"dt":1675015200,"main":{"temp":22.21,"feels_like":22,"temp_min":22.21,"temp_max":22.21,"pressure":1012,"sea_level":1012,"grnd_level":1007,"humidity":58,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":2.69,"deg":338,"gust":3.5},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-29 18:00:00"},{"dt":1675026000,"main":{"temp":21.01,"feels_like":20.68,"temp_min":21.01,"temp_max":21.01,"pressure":1011,"sea_level":1011,"grnd_level":1006,"humidity":58,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":3.11,"deg":353,"gust":4.27},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-29 21:00:00"},{"dt":1675036800,"main":{"temp":19.91,"feels_like":19.39,"temp_min":19.91,"temp_max":19.91,"pressure":1011,"sea_level":1011,"grnd_level":1006,"humidity":55,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":2.45,"deg":33,"gust":3.34},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2023-01-30 00:00:00"},{"dt":1675047600,"main":{"temp":20.82,"feels_like":20.24,"temp_min":20.82,"temp_max":20.82,"pressure":1013,"sea_level":1013,"grnd_level":1008,"humidity":49,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":2.64,"deg":20,"gust":3.62},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2023-01-30 03:00:00"}],"city":{"id":1254661,"name":"Thāne","coord":{"lat":19.18,"lon":72.941},"country":"IN","population":1261517,"timezone":19800,"sunrise":1674611050,"sunset":1674651382}}';
      var afterDecode = json.decode(jsonString);
      //ForecastMainModel forecastMainModel = ForecastMainModel.fromJson(response?.data ?? "");
      ForecastMainModel forecastMainModel = ForecastMainModel.fromJson(afterDecode);
      //_logger.log(_TAG, "Forecast main model $forecastMainModel");
      if(forecastMainModel.forecastList != null && forecastMainModel.forecastList!.isNotEmpty){
        List<GraphPoint> points = [];

        for(var i = 0; i < 15; i++){
          var currentPoint = GraphPoint(x: i.toDouble(), y: forecastMainModel.forecastList![i].weatherMain!.temp!);
          points.add(currentPoint);
        }
        state = ForecastScreenEvents.displayGraph(points, forecastMainModel);
      }
    });
  }

  void setStateName(String name){
    stateName = name;
  }

}